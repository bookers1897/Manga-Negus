<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MangaNegus v2.3</title>
    
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/regular/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/fill/style.css">
    
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Background -->
    <div class="ambient-bg"></div>
    
    <!-- App Container -->
    <div class="app-container">
        
        <!-- Header -->
        <header class="header glass-panel">
            <button class="nav-btn glass-btn" id="menu-btn">
                <i class="ph ph-list"></i>
            </button>
            
            <div class="header-center">
                <div class="logo-container">
                    <div class="logo-glow"></div>
                    <img src="/static/images/sharingan.png" alt="Logo" class="logo-image" 
                         onerror="this.style.display='none'">
                </div>
                <h1 class="app-title">æ¼«ç”»ã‚­ãƒ³ã‚°</h1>
            </div>
            
            <button class="nav-btn glass-btn" id="library-btn">
                <i class="ph ph-books"></i>
            </button>
        </header>

        <!-- Source Selector -->
        <div class="source-bar glass-panel">
            <div class="source-selector">
                <span class="source-label">Source:</span>
                <select class="source-select glass-input" id="source-select">
                    <option value="">Loading...</option>
                </select>
                <button class="source-status-btn glass-btn" id="source-status-btn" title="Source Status">
                    <i class="ph ph-pulse"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content glass-panel">
            
            <!-- Search View -->
            <section class="view-panel active" id="search-view">
                <div class="search-container">
                    <i class="ph ph-magnifying-glass search-icon"></i>
                    <input type="text" class="glass-input search-input" id="search-input"
                           placeholder="Search manga..." autocomplete="off">
                    <button class="glass-btn glass-btn-accent search-btn" id="search-btn">Search</button>
                </div>
                
                <div class="section-header">
                    <i class="ph-fill ph-fire"></i>
                    <span>Trending Now</span>
                </div>
                
                <div class="results-grid" id="results-grid">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <span>Loading...</span>
                    </div>
                </div>
            </section>

            <!-- Library View -->
            <section class="view-panel" id="library-view">
                <div class="library-header">
                    <h2>My Library</h2>
                    <div class="library-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="reading">Reading</button>
                        <button class="filter-btn" data-filter="plan_to_read">Plan to Read</button>
                        <button class="filter-btn" data-filter="completed">Completed</button>
                    </div>
                </div>
                
                <div class="library-grid" id="library-grid">
                    <div class="empty-state">
                        <i class="ph ph-books"></i>
                        <p>Your library is empty</p>
                    </div>
                </div>
            </section>

            <!-- Details View -->
            <section class="view-panel" id="details-view">
                <button class="back-btn glass-btn" id="back-btn">
                    <i class="ph ph-arrow-left"></i> Back
                </button>
                
                <div class="title-card glass-panel-elevated" id="title-card"></div>
                
                <div class="chapter-controls">
                    <div class="chapter-label">
                        Chapters <span class="chapter-count" id="chapter-count">(0)</span>
                    </div>
                    <div class="chapter-actions">
                        <button class="chapter-action-btn glass-btn" id="select-all-btn">
                            <i class="ph ph-check-square"></i> All
                        </button>
                        <button class="chapter-action-btn glass-btn" id="clear-selection-btn">
                            <i class="ph ph-square"></i> Clear
                        </button>
                    </div>
                </div>
                
                <div class="chapter-grid" id="chapter-grid">
                    <div class="loading-state">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="load-more-container" id="load-more-container" style="display:none;">
                    <button class="load-more-btn" id="load-more-btn">
                        <i class="ph ph-plus-circle"></i> Load More
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer glass-panel">
            <span class="footer-brand">MangaNegus v2.3</span>
            <a href="https://github.com/bookers1897/Manga-Negus" target="_blank" class="footer-link">
                <i class="ph ph-github-logo"></i> GitHub
            </a>
        </footer>
    </div>

    <!-- Hamburger Menu -->
    <div class="menu-overlay" id="menu-overlay"></div>
    <nav class="hamburger-menu glass-panel-elevated" id="hamburger-menu">
        <div class="menu-header">
            <h2 class="menu-title">Menu</h2>
            <button class="glass-btn nav-btn" id="close-menu-btn">
                <i class="ph ph-x"></i>
            </button>
        </div>
        <div class="menu-nav">
            <button class="menu-item" data-view="search">
                <i class="ph ph-magnifying-glass"></i> Search
            </button>
            <button class="menu-item" data-view="library">
                <i class="ph ph-books"></i> Library
            </button>
        </div>
    </nav>

    <!-- Floating Action Bar -->
    <div class="floating-bar glass-panel-elevated" id="floating-bar">
        <div class="selection-count glass-btn-accent" id="selection-count">0</div>
        <span class="floating-bar-text">selected</span>
        <button class="glass-btn download-btn" id="download-selected-btn">
            <i class="ph ph-download"></i> Download
        </button>
    </div>

    <!-- Console -->
    <button class="console-toggle glass-btn" id="console-toggle">
        <i class="ph ph-terminal"></i>
    </button>
    <div class="console-panel glass-panel-elevated" id="console-panel">
        <div class="console-resize-handle"><div class="resize-bar"></div></div>
        <div class="console-content" id="console-content">
            <div class="log-entry">MangaNegus v2.3 initialized</div>
        </div>
    </div>

    <!-- Reader -->
    <div class="reader-container" id="reader-container">
        <header class="reader-header">
            <button class="reader-close-btn" id="reader-close-btn">
                <i class="ph ph-x"></i>
            </button>
            <h3 class="reader-title" id="reader-title">Chapter</h3>
            <button class="reader-quality-toggle" id="quality-toggle">HD</button>
        </header>
        <div class="reader-content" id="reader-content"></div>
        <footer class="reader-footer">
            <button class="reader-nav-btn" id="prev-chapter-btn">
                <i class="ph ph-caret-left"></i> Prev
            </button>
            <span class="reader-page-indicator" id="page-indicator">1 / ?</span>
            <button class="reader-nav-btn" id="next-chapter-btn">
                Next <i class="ph ph-caret-right"></i>
            </button>
        </footer>
    </div>

    <!-- Source Status Modal -->
    <div class="modal-overlay" id="source-modal-overlay">
        <div class="modal glass-panel-elevated" id="source-modal">
            <div class="modal-header">
                <h3>Source Status</h3>
                <button class="glass-btn nav-btn" id="close-source-modal">
                    <i class="ph ph-x"></i>
                </button>
            </div>
            <div class="modal-content" id="source-status-content"></div>
        </div>
    </div>

    <script>
    // =========================================================================
    // MangaNegus v2.3 - Frontend JavaScript
    // =========================================================================

    // HTML escaping utility to prevent XSS
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    const PLACEHOLDER_IMAGE = '/static/images/placeholder.svg';

    // Sanitize URL to prevent javascript: protocol attacks
    function sanitizeUrl(url) {
        if (!url) return PLACEHOLDER_IMAGE;
        try {
            const parsed = new URL(url, window.location.origin);
            if (parsed.protocol === 'javascript:' || parsed.protocol === 'data:') {
                return PLACEHOLDER_IMAGE;
            }
            return url;
        } catch {
            return PLACEHOLDER_IMAGE;
        }
    }

    // Proxy external image URLs through our backend to avoid CORS issues
    function proxyImageUrl(url) {
        if (!url) return PLACEHOLDER_IMAGE;
        // If already a local URL, return as-is
        if (url.startsWith('/')) return url;
        // Proxy external URLs
        return `/api/proxy/image?url=${encodeURIComponent(url)}`;
    }

    const App = {
        currentView: 'search',
        previousView: 'search',
        currentManga: null,
        chapters: [],
        selectedChapters: new Set(),
        sources: [],
        activeSource: null,
        chapterOffset: 0,
        hasMoreChapters: false,
        elements: {},
        csrfToken: null,

        async init() {
            await this.fetchCsrfToken();
            this.cacheElements();
            this.bindEvents();
            this.loadSources();
            this.startLogPolling();
        },

        async fetchCsrfToken() {
            try {
                const resp = await fetch('/api/csrf-token');
                const data = await resp.json();
                this.csrfToken = data.csrf_token;
            } catch (e) {
                console.error('Failed to fetch CSRF token:', e);
            }
        },

        // Helper method for POST requests with CSRF token
        async postJson(url, data = {}) {
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': this.csrfToken
                },
                body: JSON.stringify(data)
            });
        },

        // Loading state management
        isLoading: false,

        setLoading(loading) {
            this.isLoading = loading;
            // Disable/enable interactive elements during loading
            const buttons = [
                this.elements.searchBtn,
                this.elements.selectAllBtn,
                this.elements.clearSelectionBtn,
                this.elements.downloadSelectedBtn,
                this.elements.loadMoreBtn
            ];
            buttons.forEach(btn => {
                if (btn) btn.disabled = loading;
            });
            if (this.elements.searchInput) {
                this.elements.searchInput.disabled = loading;
            }
        },
        
        cacheElements() {
            this.elements = {
                searchView: document.getElementById('search-view'),
                libraryView: document.getElementById('library-view'),
                detailsView: document.getElementById('details-view'),
                menuBtn: document.getElementById('menu-btn'),
                libraryBtn: document.getElementById('library-btn'),
                sourceSelect: document.getElementById('source-select'),
                sourceStatusBtn: document.getElementById('source-status-btn'),
                searchInput: document.getElementById('search-input'),
                searchBtn: document.getElementById('search-btn'),
                resultsGrid: document.getElementById('results-grid'),
                libraryGrid: document.getElementById('library-grid'),
                backBtn: document.getElementById('back-btn'),
                titleCard: document.getElementById('title-card'),
                chapterGrid: document.getElementById('chapter-grid'),
                chapterCount: document.getElementById('chapter-count'),
                selectAllBtn: document.getElementById('select-all-btn'),
                clearSelectionBtn: document.getElementById('clear-selection-btn'),
                loadMoreBtn: document.getElementById('load-more-btn'),
                loadMoreContainer: document.getElementById('load-more-container'),
                floatingBar: document.getElementById('floating-bar'),
                selectionCount: document.getElementById('selection-count'),
                downloadSelectedBtn: document.getElementById('download-selected-btn'),
                consoleToggle: document.getElementById('console-toggle'),
                consolePanel: document.getElementById('console-panel'),
                consoleContent: document.getElementById('console-content'),
                menuOverlay: document.getElementById('menu-overlay'),
                hamburgerMenu: document.getElementById('hamburger-menu'),
                closeMenuBtn: document.getElementById('close-menu-btn'),
                readerContainer: document.getElementById('reader-container'),
                readerContent: document.getElementById('reader-content'),
                readerTitle: document.getElementById('reader-title'),
                readerCloseBtn: document.getElementById('reader-close-btn'),
                sourceModalOverlay: document.getElementById('source-modal-overlay'),
                sourceStatusContent: document.getElementById('source-status-content'),
                closeSourceModal: document.getElementById('close-source-modal')
            };
        },
        
        bindEvents() {
            // Navigation
            this.elements.menuBtn.addEventListener('click', () => this.toggleMenu(true));
            this.elements.closeMenuBtn.addEventListener('click', () => this.toggleMenu(false));
            this.elements.menuOverlay.addEventListener('click', () => this.toggleMenu(false));
            this.elements.libraryBtn.addEventListener('click', () => this.showView('library'));
            this.elements.backBtn.addEventListener('click', () => this.showView(this.previousView || 'search'));
            
            document.querySelectorAll('.menu-item[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.showView(btn.dataset.view);
                    this.toggleMenu(false);
                });
            });
            
            // Source
            this.elements.sourceSelect.addEventListener('change', e => this.setActiveSource(e.target.value));
            this.elements.sourceStatusBtn.addEventListener('click', () => this.showSourceStatus());
            this.elements.closeSourceModal.addEventListener('click', () => this.hideSourceStatus());
            this.elements.sourceModalOverlay.addEventListener('click', e => {
                if (e.target === this.elements.sourceModalOverlay) this.hideSourceStatus();
            });
            
            // Search
            this.elements.searchBtn.addEventListener('click', () => this.search());
            this.elements.searchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') this.search();
            });
            
            // Library filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.loadLibrary(btn.dataset.filter);
                });
            });
            
            // Chapters
            this.elements.selectAllBtn.addEventListener('click', () => this.selectAllChapters());
            this.elements.clearSelectionBtn.addEventListener('click', () => this.clearSelection());
            this.elements.loadMoreBtn.addEventListener('click', () => this.loadMoreChapters());
            this.elements.downloadSelectedBtn.addEventListener('click', () => this.downloadSelected());
            
            // Console
            this.elements.consoleToggle.addEventListener('click', () => this.toggleConsole());
            
            // Reader
            this.elements.readerCloseBtn.addEventListener('click', () => this.closeReader());
        },
        
        // === Sources ===
        async loadSources() {
            try {
                const resp = await fetch('/api/sources');
                this.sources = await resp.json();
                
                this.elements.sourceSelect.innerHTML = this.sources.map(s =>
                    `<option value="${escapeHtml(s.id)}" ${s.is_active ? 'selected' : ''}>${escapeHtml(s.icon)} ${escapeHtml(s.name)}</option>`
                ).join('');
                
                const active = this.sources.find(s => s.is_active);
                if (active) this.activeSource = active.id;
                
                this.loadPopular();
            } catch (e) {
                console.error('Failed to load sources:', e);
                this.log('âŒ Failed to load sources');
            }
        },
        
        async setActiveSource(sourceId) {
            try {
                await this.postJson('/api/sources/active', {source_id: sourceId});
                this.activeSource = sourceId;
                this.loadPopular();
            } catch (e) {
                console.error('Failed to set source:', e);
            }
        },
        
        async showSourceStatus() {
            try {
                const resp = await fetch('/api/sources/health');
                const data = await resp.json();
                
                this.elements.sourceStatusContent.innerHTML = data.sources.map(s => `
                    <div class="source-status-item ${s.is_available ? 'available' : 'unavailable'}">
                        <div class="source-info">
                            <span class="source-name">${escapeHtml(s.icon)} ${escapeHtml(s.name)}</span>
                            <span class="source-status-badge ${escapeHtml(s.status)}">${escapeHtml(s.status)}</span>
                        </div>
                        ${!s.is_available ? `
                            <button class="glass-btn reset-btn" data-source-id="${escapeHtml(s.id)}">
                                <i class="ph ph-arrow-counter-clockwise"></i> Reset
                            </button>
                        ` : ''}
                    </div>
                `).join('');

                // Bind reset buttons with event listeners instead of inline onclick
                this.elements.sourceStatusContent.querySelectorAll('.reset-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.resetSource(btn.dataset.sourceId));
                });
                
                this.elements.sourceModalOverlay.classList.add('active');
            } catch (e) {
                console.error('Failed to load source status:', e);
            }
        },
        
        hideSourceStatus() {
            this.elements.sourceModalOverlay.classList.remove('active');
        },
        
        async resetSource(sourceId) {
            await this.postJson(`/api/sources/${sourceId}/reset`, {});
            this.showSourceStatus();
        },
        
        // === Views ===
        showView(view) {
            this.previousView = this.currentView;
            this.currentView = view;
            
            document.querySelectorAll('.view-panel').forEach(v => v.classList.remove('active'));
            document.getElementById(`${view}-view`)?.classList.add('active');
            
            if (view === 'library') this.loadLibrary();
        },
        
        toggleMenu(show) {
            this.elements.hamburgerMenu.classList.toggle('active', show);
            this.elements.menuOverlay.classList.toggle('active', show);
        },
        
        toggleConsole() {
            this.elements.consolePanel.classList.toggle('active');
            this.elements.consoleToggle.classList.toggle('active');
        },
        
        // === Search ===
        async loadPopular() {
            this.elements.resultsGrid.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
            
            try {
                const resp = await fetch('/api/popular');
                const results = await resp.json();
                this.renderResults(results);
            } catch (e) {
                this.elements.resultsGrid.innerHTML = '<div class="empty-state"><i class="ph ph-warning"></i><p>Failed to load</p></div>';
            }
        },
        
        async search() {
            const query = this.elements.searchInput.value.trim();
            if (!query || this.isLoading) return;

            this.setLoading(true);
            this.elements.resultsGrid.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';

            try {
                const resp = await this.postJson('/api/search', {query});
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Search failed');
                }
                const results = await resp.json();
                this.renderResults(results);
            } catch (e) {
                this.elements.resultsGrid.innerHTML = `<div class="empty-state"><i class="ph ph-warning"></i><p>${escapeHtml(e.message || 'Search failed')}</p></div>`;
            } finally {
                this.setLoading(false);
            }
        },
        
        renderResults(results) {
            if (!results.length) {
                this.elements.resultsGrid.innerHTML = '<div class="empty-state"><i class="ph ph-magnifying-glass"></i><p>No results</p></div>';
                return;
            }
            
            this.elements.resultsGrid.innerHTML = results.map(m => `
                <div class="manga-card glass-panel" data-id="${escapeHtml(m.id)}" data-source="${escapeHtml(m.source)}">
                    <img class="manga-card-cover" src="${proxyImageUrl(m.cover)}"
                         alt="${escapeHtml(m.title)}" loading="lazy" onerror="this.src='/static/images/placeholder.svg'">
                    <div class="manga-card-content">
                        <h3 class="manga-card-title">${escapeHtml(m.title)}</h3>
                        <p class="manga-card-desc">${escapeHtml(m.author || m.source)}</p>
                        <div class="manga-card-footer">
                            <span class="manga-card-label">${escapeHtml(m.source)}</span>
                            <button class="glass-btn add-btn"><i class="ph ph-plus"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.manga-card').forEach(card => {
                card.addEventListener('click', e => {
                    if (!e.target.closest('.add-btn')) {
                        this.showMangaDetails(card.dataset.id, card.dataset.source);
                    }
                });
                card.querySelector('.add-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    const manga = results.find(m => m.id === card.dataset.id);
                    this.addToLibrary(manga);
                });
            });
        },
        
        // === Library ===
        async loadLibrary(filter = 'all') {
            try {
                const resp = await fetch('/api/library');
                const lib = await resp.json();
                
                let items = Object.entries(lib);
                if (filter !== 'all') items = items.filter(([k, m]) => m.status === filter);
                
                if (!items.length) {
                    this.elements.libraryGrid.innerHTML = '<div class="empty-state"><i class="ph ph-books"></i><p>Empty</p></div>';
                    return;
                }
                
                this.elements.libraryGrid.innerHTML = items.map(([key, m]) => `
                    <div class="library-item glass-panel" data-key="${escapeHtml(key)}" data-source="${escapeHtml(m.source)}" data-id="${escapeHtml(m.manga_id)}">
                        <img class="library-item-cover" src="${proxyImageUrl(m.cover)}"
                             alt="${escapeHtml(m.title)}" loading="lazy" onerror="this.src='/static/images/placeholder.svg'">
                        <div class="library-item-info">
                            <h3 class="library-item-title">${escapeHtml(m.title)}</h3>
                            <p class="library-item-progress">${m.last_chapter ? `Ch. ${escapeHtml(m.last_chapter)}` : 'Not started'}</p>
                        </div>
                    </div>
                `).join('');
                
                document.querySelectorAll('.library-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.showMangaDetails(item.dataset.id, item.dataset.source);
                    });
                });
            } catch (e) {
                console.error('Failed to load library:', e);
            }
        },
        
        async addToLibrary(manga) {
            try {
                await this.postJson('/api/save', {
                    id: manga.id,
                    title: manga.title,
                    source: manga.source,
                    cover: manga.cover,
                    status: 'reading'
                });
                this.log(`ðŸ“š Added: ${manga.title}`);
            } catch (e) {
                console.error('Failed to add:', e);
            }
        },
        
        // === Details ===
        async showMangaDetails(mangaId, sourceId) {
            this.currentManga = {id: mangaId, source: sourceId, title: ''};
            this.chapters = [];
            this.selectedChapters.clear();
            this.chapterOffset = 0;
            this.updateFloatingBar();
            
            this.showView('details');
            
            this.elements.titleCard.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
            this.elements.chapterGrid.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
            
            await this.loadChapters();
        },
        
        async loadChapters() {
            try {
                const resp = await this.postJson('/api/chapters', {
                    id: this.currentManga.id,
                    source: this.currentManga.source,
                    offset: this.chapterOffset,
                    limit: 100
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Failed to load chapters');
                }

                const data = await resp.json();

                if (this.chapterOffset === 0) {
                    this.chapters = data.chapters;
                } else {
                    this.chapters = [...this.chapters, ...data.chapters];
                }

                this.hasMoreChapters = data.hasMore;
                this.chapterOffset = data.nextOffset;

                this.renderTitleCard();
                this.renderChapters();

                this.elements.loadMoreContainer.style.display = this.hasMoreChapters ? 'block' : 'none';
            } catch (e) {
                console.error('Failed to load chapters:', e);
                this.elements.chapterGrid.innerHTML = `<div class="empty-state"><i class="ph ph-warning"></i><p>${escapeHtml(e.message || 'Failed to load chapters')}</p></div>`;
            }
        },
        
        async loadMoreChapters() {
            this.elements.loadMoreBtn.disabled = true;
            this.elements.loadMoreBtn.innerHTML = '<div class="spinner"></div> Loading...';
            await this.loadChapters();
            this.elements.loadMoreBtn.disabled = false;
            this.elements.loadMoreBtn.innerHTML = '<i class="ph ph-plus-circle"></i> Load More';
        },
        
        renderTitleCard() {
            this.elements.titleCard.innerHTML = `
                <div class="title-card-header">
                    <h2 class="manga-title">${this.currentManga.source} / ${this.currentManga.id.substring(0,8)}...</h2>
                </div>
                <div class="quick-download glass-panel">
                    <div class="quick-download-header"><span class="quick-download-label">Quick Download</span></div>
                    <div class="download-input-row">
                        <div class="input-group">
                            <input type="number" class="glass-input chapter-input" id="start-chapter" placeholder="Start" min="1">
                            <span class="input-arrow">â†’</span>
                            <input type="number" class="glass-input chapter-input" id="end-chapter" placeholder="End" min="1">
                        </div>
                        <button class="glass-btn download-btn dl-btn" id="quick-download-btn">
                            <i class="ph ph-download"></i>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('quick-download-btn').addEventListener('click', () => {
                const start = parseFloat(document.getElementById('start-chapter').value);
                const end = parseFloat(document.getElementById('end-chapter').value);
                this.downloadRange(start, end);
            });
            
            this.elements.chapterCount.textContent = `(${this.chapters.length})`;
        },
        
        renderChapters() {
            if (!this.chapters.length) {
                this.elements.chapterGrid.innerHTML = '<div class="empty-state"><i class="ph ph-book-open"></i><p>No chapters</p></div>';
                return;
            }
            
            this.elements.chapterGrid.innerHTML = this.chapters.map(ch => `
                <div class="chapter-item glass-panel ${this.selectedChapters.has(ch.id) ? 'selected' : ''}"
                     data-id="${escapeHtml(ch.id)}" data-chapter="${escapeHtml(ch.chapter)}">
                    <div class="chapter-checkbox"><i class="ph ph-check"></i></div>
                    <span class="chapter-num">Ch. ${escapeHtml(ch.chapter)}</span>
                    ${ch.title ? `<span class="chapter-title">${escapeHtml(ch.title)}</span>` : ''}
                </div>
            `).join('');
            
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.addEventListener('click', () => this.toggleChapter(item.dataset.id));
                item.addEventListener('dblclick', () => this.openReader(item.dataset.id, item.dataset.chapter));
            });
        },
        
        toggleChapter(id) {
            if (this.selectedChapters.has(id)) {
                this.selectedChapters.delete(id);
            } else {
                this.selectedChapters.add(id);
            }
            document.querySelector(`[data-id="${id}"]`)?.classList.toggle('selected');
            this.updateFloatingBar();
        },
        
        selectAllChapters() {
            this.chapters.forEach(ch => this.selectedChapters.add(ch.id));
            document.querySelectorAll('.chapter-item').forEach(el => el.classList.add('selected'));
            this.updateFloatingBar();
        },
        
        clearSelection() {
            this.selectedChapters.clear();
            document.querySelectorAll('.chapter-item').forEach(el => el.classList.remove('selected'));
            this.updateFloatingBar();
        },
        
        updateFloatingBar() {
            const count = this.selectedChapters.size;
            this.elements.selectionCount.textContent = count;
            this.elements.floatingBar.classList.toggle('active', count > 0);
        },
        
        // === Downloads ===
        async downloadSelected() {
            if (!this.selectedChapters.size) return;
            const toDownload = this.chapters.filter(ch => this.selectedChapters.has(ch.id));
            await this.startDownload(toDownload);
            this.clearSelection();
        },
        
        async downloadRange(start, end) {
            if (!start || !end) {
                this.log('âš ï¸ Enter start and end chapters');
                return;
            }
            const toDownload = this.chapters.filter(ch => {
                const num = parseFloat(ch.chapter);
                return num >= start && num <= end;
            });
            if (!toDownload.length) {
                this.log('âš ï¸ No chapters in range');
                return;
            }
            await this.startDownload(toDownload);
        },
        
        async startDownload(chapters) {
            try {
                await this.postJson('/api/download', {
                    chapters: chapters,
                    title: `manga_${this.currentManga.id.substring(0,8)}`,
                    source: this.currentManga.source
                });
            } catch (e) {
                this.log('âŒ Download failed');
            }
        },
        
        // === Reader ===
        async openReader(chapterId, chapterNum) {
            this.elements.readerContainer.classList.add('active');
            this.elements.readerTitle.textContent = `Chapter ${chapterNum}`;
            this.elements.readerContent.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';

            try {
                const resp = await this.postJson('/api/chapter_pages', {
                    chapter_id: chapterId,
                    source: this.currentManga.source
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Failed to load pages');
                }

                const data = await resp.json();

                if (!data.pages?.length) {
                    this.elements.readerContent.innerHTML = '<div class="empty-state"><p>No pages found for this chapter</p></div>';
                    return;
                }

                this.elements.readerContent.innerHTML = data.pages.map((url, i) =>
                    `<img class="reader-page" src="${sanitizeUrl(url)}" alt="Page ${i+1}" loading="lazy">`
                ).join('');
            } catch (e) {
                console.error('Failed to load reader:', e);
                this.elements.readerContent.innerHTML = `<div class="empty-state"><p>${escapeHtml(e.message || 'Failed to load chapter')}</p></div>`;
            }
        },
        
        closeReader() {
            this.elements.readerContainer.classList.remove('active');
        },
        
        // === Logging ===
        log(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = msg;
            this.elements.consoleContent.appendChild(entry);
            this.elements.consoleContent.scrollTop = this.elements.consoleContent.scrollHeight;
        },
        
        startLogPolling() {
            setInterval(async () => {
                try {
                    const resp = await fetch('/api/logs');
                    const data = await resp.json();
                    data.logs.forEach(msg => this.log(msg));
                } catch (e) {}
            }, 1000);
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
