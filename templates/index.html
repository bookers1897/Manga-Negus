<!--
================================================================================
MangaNegus v2.1 - Main Template
================================================================================
A modern manga downloader with in-app reader support.

Author: bookers1897
GitHub: https://github.com/bookers1897/Manga-Negus
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <!-- Responsive viewport settings for mobile -->
    <!-- maximum-scale=1 and user-scalable=no prevent unwanted zoom -->
    <!-- viewport-fit=cover ensures full screen on notched devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Êº´Áîª„Ç≠„É≥„Ç∞ - MangaNegus</title>
    
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons for UI icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Custom stylesheet (separated from HTML) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <!-- PWA & Mobile App settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
</head>

<body class="h-screen flex flex-col" data-theme="dark">
    
    <!-- ===================================================================
         BACKGROUND LAYERS
         =================================================================== -->
    
    <!-- Animated gradient ambient background -->
    <div class="ambient-bg"></div>
    
    <!-- Optional anime character background (set via JavaScript) -->
    <div class="anime-bg" id="anime-bg"></div>
    
    
    <!-- ===================================================================
         HAMBURGER MENU (Slide-out Navigation)
         =================================================================== -->
    
    <!-- Dark overlay behind menu -->
    <div class="menu-overlay" id="menu-overlay" onclick="closeMenu()"></div>
    
    <!-- Slide-out menu panel -->
    <nav class="hamburger-menu glass-panel" id="hamburger-menu">
        <!-- Menu Header -->
        <div class="menu-header">
            <span class="menu-title">Menu</span>
            <button class="glass-btn nav-btn" onclick="closeMenu()">
                <i class="ph-bold ph-x"></i>
            </button>
        </div>
        
        <!-- Menu Navigation Items -->
        <div class="menu-nav">
            <button class="menu-item" onclick="showView('search'); closeMenu()">
                <i class="ph-fill ph-magnifying-glass"></i>
                <span>Search</span>
            </button>
            
            <button class="menu-item" onclick="showView('library'); closeMenu()">
                <i class="ph-fill ph-books"></i>
                <span>Library</span>
            </button>
            
            <button class="menu-item" onclick="toggleConsole(); closeMenu()">
                <i class="ph-fill ph-terminal-window"></i>
                <span>Console</span>
            </button>
            
            <button class="menu-item" onclick="showSettings(); closeMenu()">
                <i class="ph-fill ph-gear"></i>
                <span>Settings</span>
            </button>
        </div>
        
        <!-- Menu Footer with Social Links -->
        <div class="menu-footer">
            <a href="https://github.com/bookers1897/Manga-Negus" target="_blank" class="menu-item">
                <i class="ph-fill ph-github-logo"></i>
                <span>GitHub</span>
            </a>
        </div>
    </nav>
    
    
    <!-- ===================================================================
         HEADER
         =================================================================== -->
    
    <header class="header glass-panel">
        <!-- Left: Hamburger menu button + Logo + Title -->
        <div class="flex items-center gap-2">
            <!-- Hamburger Menu Button -->
            <button class="glass-btn nav-btn" onclick="toggleMenu()" aria-label="Open menu">
                <i class="ph-bold ph-list"></i>
            </button>
            
            <!-- Logo with glow effect -->
            <div class="logo-container">
                <div class="logo-glow"></div>
                <img src="{{ url_for('static', filename='images/sharingan.png') }}" 
                     alt="Logo" 
                     class="logo-image"
                     id="logo-img"
                     onerror="this.style.display='none'; document.getElementById('fallback-icon').style.display='flex'">
                <div id="fallback-icon" style="display:none;" class="logo-image flex items-center justify-center">
                    <i class="ph-fill ph-eye text-lg" style="color: var(--accent-color);"></i>
                </div>
            </div>
            
            <!-- App Title -->
            <h1 class="app-title">Êº´Áîª„Ç≠„É≥„Ç∞</h1>
        </div>
        
        <!-- Right: Theme toggle + Search button -->
        <div class="nav-buttons">
            <!-- Theme Toggle Button -->
            <button class="glass-btn nav-btn" onclick="toggleTheme()" aria-label="Toggle theme">
                <i class="ph-fill ph-moon" id="theme-icon"></i>
            </button>
            
            <!-- Quick Search Button -->
            <button class="glass-btn nav-btn" onclick="showView('search')" aria-label="Search">
                <i class="ph-bold ph-magnifying-glass"></i>
            </button>
        </div>
    </header>
    
    
    <!-- ===================================================================
         MAIN CONTENT AREA
         =================================================================== -->
    
    <main class="main-content glass-panel flex-grow">
        
        <!-- ===============================================================
             SEARCH VIEW
             =============================================================== -->
        <div id="view-search" class="view-panel active">
            <div class="max-w-4xl mx-auto">
                
                <!-- Search Input -->
                <div class="search-container">
                    <i class="ph-bold ph-magnifying-glass search-icon"></i>
                    <input type="text" 
                           id="search-input" 
                           class="glass-input search-input" 
                           placeholder="Search manga..."
                           onkeydown="if(event.key === 'Enter') doSearch()">
                    <button class="glass-btn-accent search-btn" onclick="doSearch()">
                        Search
                    </button>
                </div>
                
                <!-- Section Header -->
                <div class="section-header" id="search-header">
                    <i class="ph-fill ph-fire"></i>
                    <span>Trending Now</span>
                </div>
                
                <!-- Results Grid -->
                <div id="search-results" class="results-grid">
                    <!-- Populated by JavaScript -->
                </div>
                
            </div>
        </div>
        
        
        <!-- ===============================================================
             LIBRARY VIEW
             =============================================================== -->
        <div id="view-library" class="view-panel">
            <div class="max-w-4xl mx-auto pb-20">
                
                <!-- Currently Reading Section -->
                <div class="library-section">
                    <div class="library-section-header reading">
                        <i class="ph-fill ph-book-open"></i>
                        <span>Currently Reading</span>
                    </div>
                    <div id="lib-reading" class="library-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Want to Read Section -->
                <div class="library-section">
                    <div class="library-section-header">
                        <i class="ph-fill ph-bookmark" style="color: var(--text-secondary);"></i>
                        <span>Want to Read</span>
                    </div>
                    <div id="lib-plan_to_read" class="library-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Completed Section -->
                <div class="library-section">
                    <div class="library-section-header">
                        <i class="ph-fill ph-check-circle" style="color: var(--text-secondary);"></i>
                        <span>Completed</span>
                    </div>
                    <div id="lib-completed" class="library-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <!-- ===============================================================
             DETAILS VIEW (Manga Details + Chapter List)
             =============================================================== -->
        <div id="view-details" class="view-panel">
            <div class="max-w-3xl mx-auto">
                
                <!-- Back Button -->
                <button class="glass-btn back-btn" onclick="goBack()">
                    <i class="ph-bold ph-arrow-left"></i>
                    Back
                </button>
                
                <!-- Title Card with Cover and Info -->
                <div class="title-card glass-panel-elevated">
                    <div class="title-card-header">
                        <!-- Cover Image -->
                        <img id="detail-cover" 
                             class="title-card-cover" 
                             src="" 
                             alt="Cover"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>'">
                        
                        <!-- Info -->
                        <div class="title-card-info">
                            <h2 id="detail-title" class="manga-title">Manga Title</h2>
                            
                            <!-- Status Selector -->
                            <select id="status-select" class="glass-input status-select" onchange="changeStatus()">
                                <option value="none">Not in Library</option>
                                <option value="reading">Currently Reading</option>
                                <option value="plan_to_read">Want to Read</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Quick Download Section -->
                    <div class="quick-download glass-panel">
                        <div class="quick-download-header">
                            <span class="quick-download-label">Quick Download</span>
                            <button class="glass-btn" style="font-size: 0.625rem; padding: 0.25rem 0.5rem;" onclick="fillMaxRange()">
                                Max Range
                            </button>
                        </div>
                        
                        <!-- FIXED: Download Input Row -->
                        <div class="download-input-row">
                            <div class="input-group">
                                <input type="number" 
                                       id="dl-start" 
                                       class="glass-input chapter-input" 
                                       placeholder="Start">
                                <span class="input-arrow">‚Üí</span>
                                <input type="number" 
                                       id="dl-end" 
                                       class="glass-input chapter-input" 
                                       placeholder="End">
                            </div>
                            <button class="download-btn dl-btn" onclick="downloadRange()">
                                <i class="ph-bold ph-download-simple"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chapter Controls -->
                <div class="chapter-controls">
                    <span class="chapter-label">
                        Chapters <span id="chapter-count" class="chapter-count">(0)</span>
                    </span>
                    <div class="chapter-actions">
                        <button class="glass-btn chapter-action-btn" onclick="toggleSort()">
                            <i id="sort-icon" class="ph-bold ph-arrow-down"></i>
                        </button>
                        <button class="glass-btn chapter-action-btn accent" onclick="selectAll()">All</button>
                        <button class="glass-btn chapter-action-btn" onclick="deselectAll()">Clear</button>
                    </div>
                </div>
                
                <!-- Chapter Grid -->
                <div id="chapter-list" class="chapter-grid">
                    <!-- Populated by JavaScript -->
                </div>
                
                <!-- Load More Button -->
                <div id="load-more-container" class="load-more-container hidden">
                    <button id="load-more-btn" class="load-more-btn" onclick="loadMoreChapters()">
                        <i class="ph-bold ph-plus-circle"></i>
                        <span>Load More Chapters</span>
                    </button>
                </div>
                
            </div>
        </div>
        
    </main>
    
    
    <!-- ===================================================================
         MANGA READER (Full-screen overlay)
         =================================================================== -->
    
    <div id="reader-container" class="reader-container">
        <!-- Reader Header -->
        <div class="reader-header">
            <span id="reader-title" class="reader-title">Chapter Title</span>
            <div class="flex items-center gap-2">
                <button id="quality-toggle" class="reader-quality-toggle" onclick="toggleDataSaver()">
                    HD
                </button>
                <button class="reader-close-btn" onclick="closeReader()">
                    <i class="ph-bold ph-x"></i>
                </button>
            </div>
        </div>
        
        <!-- Reader Content (scrollable page list) -->
        <div id="reader-content" class="reader-content">
            <!-- Pages populated by JavaScript -->
        </div>
        
        <!-- Reader Footer with Navigation -->
        <div class="reader-footer">
            <button id="prev-chapter-btn" class="reader-nav-btn" onclick="prevChapter()">
                <i class="ph-bold ph-caret-left"></i>
                Prev
            </button>
            <span id="reader-page-indicator" class="reader-page-indicator">Ch. 1</span>
            <button id="next-chapter-btn" class="reader-nav-btn" onclick="nextChapter()">
                Next
                <i class="ph-bold ph-caret-right"></i>
            </button>
        </div>
    </div>
    
    
    <!-- ===================================================================
         FLOATING SELECTION BAR
         =================================================================== -->
    
    <div id="floating-bar" class="floating-bar glass-panel-elevated">
        <div id="selection-count" class="selection-count download-btn">0</div>
        <button class="floating-bar-text" onclick="downloadSelection()" style="background: none; border: none; cursor: pointer;">
            Download Selected
        </button>
    </div>
    
    
    <!-- ===================================================================
         CONSOLE TOGGLE BUTTON
         =================================================================== -->
    
    <button id="console-toggle-btn" class="glass-btn console-toggle" onclick="toggleConsole()">
        <i class="ph-bold ph-terminal"></i>
    </button>
    
    
    <!-- ===================================================================
         CONSOLE PANEL
         =================================================================== -->
    
    <div id="console-panel" class="console-panel glass-panel">
        <!-- Resize Handle -->
        <div id="console-resize-handle" class="console-resize-handle">
            <div class="resize-bar"></div>
        </div>
        
        <!-- Console Content -->
        <div id="console-content" class="console-content">
            <div style="text-align: center; opacity: 0.5; font-weight: 600; font-size: 0.5625rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;">
                System Logs
            </div>
        </div>
    </div>
    
    
    <!-- ===================================================================
         FOOTER
         =================================================================== -->
    
    <footer class="app-footer glass-panel">
        <div class="footer-content">
            <span class="footer-brand">MangaNegus v2.1 ‚Ä¢ Made with ‚ù§Ô∏è</span>
            <div class="footer-links">
                <a href="https://github.com/bookers1897/Manga-Negus" target="_blank" class="footer-link">
                    <i class="ph-fill ph-github-logo"></i>
                    GitHub
                </a>
                <a href="https://github.com/bookers1897" target="_blank" class="footer-link">
                    <i class="ph-fill ph-user"></i>
                    @bookers1897
                </a>
            </div>
        </div>
    </footer>
    
    
    <!-- ===================================================================
         JAVASCRIPT
         =================================================================== -->
    
    <script>
        // =====================================================================
        // STATE VARIABLES
        // =====================================================================
        
        // Current manga being viewed
        let currentManga = null;
        
        // Array of loaded chapters for current manga
        let currentChapters = [];
        
        // Track if all chapters have been loaded
        let allChaptersLoaded = false;
        
        // Set of selected chapter indices for batch download
        let selectedIndices = new Set();
        
        // Chapter sort order (true = ascending, false = descending)
        let isAscending = true;
        
        // Pagination offset for loading more chapters
        let nextOffset = 0;
        
        // Total number of chapters available
        let totalChapters = 0;
        
        // Downloaded chapters for current manga
        let downloadedChapters = [];
        
        // Reader state
        let readerChapters = [];      // All chapters for navigation
        let currentChapterIndex = 0;  // Index in readerChapters
        let useDataSaver = false;     // Use compressed images
        
        // Previous view for back navigation
        let previousView = 'search';
        
        
        // =====================================================================
        // THEME MANAGEMENT
        // =====================================================================
        
        /**
         * Toggle between dark and light themes.
         * Saves preference to localStorage for persistence.
         */
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                // Switch to light theme
                body.setAttribute('data-theme', 'light');
                icon.className = 'ph-fill ph-sun';
                localStorage.setItem('theme', 'light');
            } else {
                // Switch to dark theme
                body.setAttribute('data-theme', 'dark');
                icon.className = 'ph-fill ph-moon';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        
        // =====================================================================
        // HAMBURGER MENU
        // =====================================================================
        
        /**
         * Toggle the hamburger menu open/closed.
         */
        function toggleMenu() {
            const menu = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('menu-overlay');
            
            menu.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        /**
         * Close the hamburger menu.
         */
        function closeMenu() {
            const menu = document.getElementById('hamburger-menu');
            const overlay = document.getElementById('menu-overlay');
            
            menu.classList.remove('active');
            overlay.classList.remove('active');
        }
        
        
        // =====================================================================
        // VIEW MANAGEMENT
        // =====================================================================
        
        /**
         * Switch to a different view panel.
         * 
         * @param {string} viewName - Name of view ('search', 'library', 'details')
         */
        function showView(viewName) {
            // Save current view for back navigation
            const currentActive = document.querySelector('.view-panel.active');
            if (currentActive) {
                previousView = currentActive.id.replace('view-', '');
            }
            
            // Hide all views
            document.querySelectorAll('.view-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Show requested view
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.classList.add('active');
            }
            
            // Load data for specific views
            if (viewName === 'search') {
                // Load popular manga if search is empty
                if (!document.getElementById('search-input').value) {
                    loadPopular();
                }
            } else if (viewName === 'library') {
                loadLibrary();
            }
            
            // Update floating bar visibility
            updateFloatingBar();
        }
        
        /**
         * Navigate back to the previous view.
         */
        function goBack() {
            showView(previousView);
        }
        
        
        // =====================================================================
        // CONSOLE PANEL
        // =====================================================================
        
        /**
         * Toggle the console panel visibility.
         */
        function toggleConsole() {
            const panel = document.getElementById('console-panel');
            const btn = document.getElementById('console-toggle-btn');
            
            panel.classList.toggle('active');
            btn.classList.toggle('active');
            
            // Refresh logs when opening
            if (panel.classList.contains('active')) {
                refreshLogs();
            }
        }
        
        /**
         * Fetch and display new log messages from the server.
         */
        async function refreshLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                const container = document.getElementById('console-content');
                
                if (data.logs && data.logs.length) {
                    data.logs.forEach(msg => {
                        const entry = document.createElement('div');
                        entry.className = 'log-entry';
                        entry.textContent = msg;
                        container.appendChild(entry);
                    });
                    
                    // Auto-scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }
        
        
        // =====================================================================
        // API HELPERS
        // =====================================================================
        
        /**
         * Make a POST request to the API.
         * 
         * @param {string} url - API endpoint
         * @param {object} data - Data to send
         * @returns {Promise<object|null>} Response data or null on error
         */
        async function post(url, data) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }
        
        /**
         * Extract the English title from a manga object.
         * Falls back to other languages if English is not available.
         * 
         * @param {object} manga - Manga object from MangaDex API
         * @returns {string} English or fallback title
         */
        function getEnglishTitle(manga) {
            const attrs = manga.attributes;
            
            // Try English title first
            if (attrs.title.en) return attrs.title.en;
            
            // Try alt titles
            if (attrs.altTitles) {
                const englishAlt = attrs.altTitles.find(t => t.en);
                if (englishAlt) return englishAlt.en;
            }
            
            // Fallback to any available title
            return Object.values(attrs.title)[0] || 'Unknown';
        }
        
        /**
         * Extract cover art URL from a manga object.
         * 
         * @param {object} manga - Manga object from MangaDex API
         * @returns {string|null} Cover URL or null if not found
         */
        function getCoverUrl(manga) {
            const relationships = manga.relationships || [];
            
            for (const rel of relationships) {
                if (rel.type === 'cover_art') {
                    const filename = rel.attributes?.fileName;
                    if (filename) {
                        return `https://uploads.mangadex.org/covers/${manga.id}/${filename}.256.jpg`;
                    }
                }
            }
            
            return null;
        }
        
        
        // =====================================================================
        // SEARCH & DISCOVERY
        // =====================================================================
        
        /**
         * Load popular manga for the home page.
         */
        async function loadPopular() {
            const results = document.getElementById('search-results');
            const header = document.getElementById('search-header');
            
            // Don't reload if already populated
            if (results.children.length > 0 && results.querySelector('.manga-card')) {
                return;
            }
            
            header.style.display = 'flex';
            header.querySelector('span').textContent = 'Trending Now';
            
            // Show loading spinner
            results.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            `;
            
            try {
                const response = await fetch('/api/popular');
                const data = await response.json();
                renderSearchResults(data);
            } catch (error) {
                console.error('Failed to load popular:', error);
                results.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">Failed to load. Try again.</div>';
            }
        }
        
        /**
         * Search for manga by query.
         */
        async function doSearch() {
            const query = document.getElementById('search-input').value.trim();
            
            if (!query) {
                loadPopular();
                return;
            }
            
            const results = document.getElementById('search-results');
            const header = document.getElementById('search-header');
            
            header.style.display = 'none';
            
            // Show loading
            results.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="spinner" style="margin: 0 auto;"></div>
                </div>
            `;
            
            const data = await post('/api/search', { query });
            renderSearchResults(data);
        }
        
        /**
         * Render search results into the grid.
         * 
         * @param {array} mangaList - Array of manga objects
         */
        function renderSearchResults(mangaList) {
            const container = document.getElementById('search-results');
            container.innerHTML = '';
            
            if (!mangaList || mangaList.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">No results found</div>';
                return;
            }
            
            mangaList.forEach(manga => {
                const title = getEnglishTitle(manga);
                const cover = getCoverUrl(manga);
                const desc = manga.attributes.description?.en || 'No description available';
                const safeTitle = title.replace(/'/g, "\\'");
                const safeCover = cover || '';
                
                const card = document.createElement('div');
                card.className = 'manga-card glass-panel';
                card.innerHTML = `
                    <img class="manga-card-cover" 
                         src="${cover || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>'}" 
                         alt="${title}"
                         loading="lazy"
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>'">
                    <div class="manga-card-content" onclick="openManga('${manga.id}', '${safeTitle}', '${safeCover}')">
                        <div class="manga-card-title">${title}</div>
                        <div class="manga-card-desc">${desc}</div>
                        <div class="manga-card-footer">
                            <span class="manga-card-label">Manga</span>
                            <button class="glass-btn add-btn" onclick="event.stopPropagation(); addToLibrary('${manga.id}', '${safeTitle}', '${safeCover}')">
                                + Add
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        
        // =====================================================================
        // LIBRARY MANAGEMENT
        // =====================================================================
        
        /**
         * Load and display the user's library.
         */
        async function loadLibrary() {
            try {
                const response = await fetch('/api/library');
                const library = await response.json();
                
                // Clear existing items
                ['reading', 'plan_to_read', 'completed'].forEach(status => {
                    document.getElementById(`lib-${status}`).innerHTML = '';
                });
                
                // Check if library is empty
                if (Object.keys(library).length === 0) {
                    document.getElementById('lib-reading').innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            Your library is empty. Search for manga to add!
                        </div>
                    `;
                    return;
                }
                
                // Render each manga in appropriate section
                for (const [id, data] of Object.entries(library)) {
                    const status = data.status || 'reading';
                    const container = document.getElementById(`lib-${status}`);
                    const safeTitle = data.title.replace(/'/g, "\\'");
                    const safeCover = (data.cover || '').replace(/'/g, "\\'");
                    
                    const item = document.createElement('div');
                    item.className = 'library-item glass-panel';
                    item.onclick = () => openManga(id, data.title, data.cover);
                    
                    item.innerHTML = `
                        <img class="library-item-cover" 
                             src="${data.cover || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>'}"
                             alt="${data.title}"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>'">
                        <div class="library-item-info">
                            <div class="library-item-title">${data.title}</div>
                            ${data.last_chapter ? `<div class="library-item-progress">Ch. ${data.last_chapter}</div>` : ''}
                        </div>
                        <i class="ph-bold ph-caret-right" style="color: var(--text-tertiary);"></i>
                    `;
                    
                    container.appendChild(item);
                }
            } catch (error) {
                console.error('Failed to load library:', error);
            }
        }
        
        /**
         * Add a manga to the library.
         */
        async function addToLibrary(id, title, cover) {
            const result = await post('/api/save', {
                id,
                title,
                status: 'reading',
                cover
            });
            
            if (result) {
                alert('‚úÖ Added to library!');
            }
        }
        
        
        // =====================================================================
        // MANGA DETAILS
        // =====================================================================
        
        /**
         * Open manga details view.
         * 
         * @param {string} id - Manga UUID
         * @param {string} title - Manga title
         * @param {string} cover - Cover URL
         */
        async function openManga(id, title, cover) {
            // Reset state
            currentManga = { id, title, cover };
            currentChapters = [];
            allChaptersLoaded = false;
            nextOffset = 0;
            downloadedChapters = [];
            deselectAll();
            isAscending = true;
            document.getElementById('sort-icon').className = 'ph-bold ph-arrow-down';
            
            // Update UI
            document.getElementById('detail-title').textContent = title;
            document.getElementById('detail-cover').src = cover || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 140%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22140%22/></svg>';
            document.getElementById('chapter-list').innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            document.getElementById('chapter-count').textContent = '(0)';
            document.getElementById('dl-start').value = '';
            document.getElementById('dl-end').value = '';
            document.getElementById('load-more-container').classList.add('hidden');
            
            // Switch to details view
            showView('details');
            
            // Load library status
            const library = await fetch('/api/library').then(r => r.json());
            document.getElementById('status-select').value = library[id]?.status || 'none';
            
            // Fetch downloaded chapters
            const downloaded = await post('/api/downloaded_chapters', { title });
            if (downloaded) {
                downloadedChapters = downloaded.chapters || [];
            }
            
            // Load chapters
            await loadChapters();
        }
        
        /**
         * Load chapters for current manga (with pagination).
         */
        async function loadChapters() {
            const result = await post('/api/chapters', {
                id: currentManga.id,
                offset: nextOffset,
                limit: 100
            });
            
            if (result && result.chapters) {
                currentChapters = currentChapters.concat(result.chapters);
                nextOffset = result.nextOffset || currentChapters.length;
                
                document.getElementById('chapter-count').textContent = `(${currentChapters.length})`;
                
                if (result.hasMore) {
                    document.getElementById('load-more-container').classList.remove('hidden');
                } else {
                    document.getElementById('load-more-container').classList.add('hidden');
                    allChaptersLoaded = true;
                }
                
                renderChapters();
            } else {
                document.getElementById('chapter-list').innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;">No chapters found</div>';
            }
        }
        
        /**
         * Load more chapters (pagination).
         */
        async function loadMoreChapters() {
            const btn = document.getElementById('load-more-btn');
            btn.innerHTML = '<div class="spinner" style="width: 1rem; height: 1rem;"></div> Loading...';
            btn.disabled = true;
            
            await loadChapters();
            
            btn.innerHTML = '<i class="ph-bold ph-plus-circle"></i> <span>Load More Chapters</span>';
            btn.disabled = false;
        }
        
        /**
         * Render the chapter grid.
         */
        function renderChapters() {
            const container = document.getElementById('chapter-list');
            container.innerHTML = '';
            
            // Sort chapters
            const chaptersToRender = isAscending 
                ? [...currentChapters] 
                : [...currentChapters].reverse();
            
            chaptersToRender.forEach((chapter, displayIndex) => {
                const actualIndex = isAscending 
                    ? displayIndex 
                    : currentChapters.length - 1 - displayIndex;
                    
                const isSelected = selectedIndices.has(actualIndex);
                const chNum = chapter.attributes.chapter;
                const chTitle = chapter.attributes.title || '';
                const isDownloaded = downloadedChapters.includes(chNum);
                
                const item = document.createElement('div');
                item.className = `chapter-item glass-panel ${isSelected ? 'selected' : ''} ${isDownloaded ? 'downloaded' : ''}`;
                item.onclick = (e) => {
                    if (e.shiftKey || e.ctrlKey) {
                        // Shift/Ctrl click for selection
                        toggleChapter(actualIndex);
                    } else {
                        // Normal click opens reader
                        openReader(actualIndex);
                    }
                };
                
                item.innerHTML = `
                    <div class="chapter-checkbox" onclick="event.stopPropagation(); toggleChapter(${actualIndex})">
                        <i class="ph-bold ph-check"></i>
                    </div>
                    <span class="chapter-num">Ch. ${chNum}</span>
                    <span class="chapter-title">${chTitle}</span>
                `;
                
                container.appendChild(item);
            });
        }
        
        
        // =====================================================================
        // CHAPTER SELECTION
        // =====================================================================
        
        /**
         * Toggle a chapter's selection state.
         */
        function toggleChapter(index) {
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
            } else {
                selectedIndices.add(index);
            }
            renderChapters();
            updateFloatingBar();
        }
        
        /**
         * Select all visible chapters.
         */
        function selectAll() {
            currentChapters.forEach((_, i) => selectedIndices.add(i));
            renderChapters();
            updateFloatingBar();
        }
        
        /**
         * Deselect all chapters.
         */
        function deselectAll() {
            selectedIndices.clear();
            renderChapters();
            updateFloatingBar();
        }
        
        /**
         * Toggle chapter sort order.
         */
        function toggleSort() {
            isAscending = !isAscending;
            document.getElementById('sort-icon').className = isAscending 
                ? 'ph-bold ph-arrow-down' 
                : 'ph-bold ph-arrow-up';
            renderChapters();
        }
        
        /**
         * Update floating action bar visibility.
         */
        function updateFloatingBar() {
            const bar = document.getElementById('floating-bar');
            const count = document.getElementById('selection-count');
            
            if (selectedIndices.size > 0) {
                bar.classList.add('active');
                count.textContent = selectedIndices.size;
            } else {
                bar.classList.remove('active');
            }
        }
        
        
        // =====================================================================
        // DOWNLOADING
        // =====================================================================
        
        /**
         * Fill the download range with min/max chapter numbers.
         */
        function fillMaxRange() {
            if (!currentChapters.length) return;
            
            const numbers = currentChapters.map(c => parseFloat(c.attributes.chapter));
            document.getElementById('dl-start').value = Math.min(...numbers);
            document.getElementById('dl-end').value = Math.max(...numbers);
        }
        
        /**
         * Download chapters in the specified range.
         */
        async function downloadRange() {
            const start = parseFloat(document.getElementById('dl-start').value);
            const end = parseFloat(document.getElementById('dl-end').value);
            
            if (isNaN(start) || isNaN(end)) {
                alert('Please enter a valid chapter range');
                return;
            }
            
            // Fetch all chapters if not loaded
            let chaptersToFilter = currentChapters;
            if (!allChaptersLoaded) {
                const allResult = await post('/api/all_chapters', { id: currentManga.id });
                if (allResult) {
                    chaptersToFilter = allResult;
                }
            }
            
            // Filter chapters in range
            const chaptersToDownload = chaptersToFilter.filter(c => {
                const num = parseFloat(c.attributes.chapter);
                return num >= start && num <= end;
            });
            
            startDownload(chaptersToDownload);
        }
        
        /**
         * Download selected chapters.
         */
        function downloadSelection() {
            const chaptersToDownload = [];
            selectedIndices.forEach(i => chaptersToDownload.push(currentChapters[i]));
            startDownload(chaptersToDownload);
        }
        
        /**
         * Start the download process.
         */
        async function startDownload(chapters) {
            if (!chapters.length) {
                alert('No chapters selected');
                return;
            }
            
            deselectAll();
            
            if (confirm(`Download ${chapters.length} chapter${chapters.length > 1 ? 's' : ''}?`)) {
                const result = await post('/api/download', {
                    chapters,
                    title: currentManga.title
                });
                
                if (result) {
                    alert('üì• Download started! Check the console for progress.');
                    
                    // Show console
                    document.getElementById('console-panel').classList.add('active');
                    document.getElementById('console-toggle-btn').classList.add('active');
                    refreshLogs();
                }
            }
        }
        
        /**
         * Update the reading status for current manga.
         */
        async function changeStatus() {
            const status = document.getElementById('status-select').value;
            
            if (!currentManga) return;
            
            if (status === 'none') {
                if (confirm('Remove from library?')) {
                    await post('/api/delete', { id: currentManga.id });
                }
            } else {
                await post('/api/save', {
                    id: currentManga.id,
                    title: currentManga.title,
                    status,
                    cover: currentManga.cover
                });
            }
        }
        
        
        // =====================================================================
        // MANGA READER
        // =====================================================================
        
        /**
         * Open the manga reader for a specific chapter.
         * 
         * @param {number} chapterIndex - Index in currentChapters array
         */
        async function openReader(chapterIndex) {
            // Store chapters for navigation
            readerChapters = currentChapters;
            currentChapterIndex = chapterIndex;
            
            // Show reader
            document.getElementById('reader-container').classList.add('active');
            
            // Load the chapter
            await loadReaderChapter();
        }
        
        /**
         * Load the current chapter into the reader.
         */
        async function loadReaderChapter() {
            const chapter = readerChapters[currentChapterIndex];
            const chNum = chapter.attributes.chapter;
            const chTitle = chapter.attributes.title;
            
            // Update header
            document.getElementById('reader-title').textContent = 
                chTitle ? `Ch. ${chNum}: ${chTitle}` : `Chapter ${chNum}`;
            document.getElementById('reader-page-indicator').textContent = `Ch. ${chNum}`;
            
            // Update navigation buttons
            document.getElementById('prev-chapter-btn').disabled = currentChapterIndex <= 0;
            document.getElementById('next-chapter-btn').disabled = currentChapterIndex >= readerChapters.length - 1;
            
            // Show loading
            const content = document.getElementById('reader-content');
            content.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
            
            // Fetch pages
            const result = await post('/api/chapter_pages', { chapter_id: chapter.id });
            
            if (result && result.pages) {
                const pages = useDataSaver ? result.pages_datasaver : result.pages;
                
                content.innerHTML = '';
                pages.forEach((url, i) => {
                    const img = document.createElement('img');
                    img.className = 'reader-page';
                    img.src = url;
                    img.alt = `Page ${i + 1}`;
                    img.loading = 'lazy';
                    content.appendChild(img);
                });
                
                // Scroll to top
                content.scrollTop = 0;
                
                // Save reading progress
                await post('/api/update_progress', {
                    id: currentManga.id,
                    chapter: chNum
                });
            } else {
                content.innerHTML = '<div class="empty-state">Failed to load pages. Try again.</div>';
            }
        }
        
        /**
         * Navigate to the previous chapter.
         */
        async function prevChapter() {
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                await loadReaderChapter();
            }
        }
        
        /**
         * Navigate to the next chapter.
         */
        async function nextChapter() {
            if (currentChapterIndex < readerChapters.length - 1) {
                currentChapterIndex++;
                await loadReaderChapter();
            }
        }
        
        /**
         * Toggle data saver (compressed images) mode.
         */
        function toggleDataSaver() {
            useDataSaver = !useDataSaver;
            const btn = document.getElementById('quality-toggle');
            btn.textContent = useDataSaver ? 'SD' : 'HD';
            btn.classList.toggle('active', useDataSaver);
            
            // Reload current chapter with new quality
            loadReaderChapter();
        }
        
        /**
         * Close the manga reader.
         */
        function closeReader() {
            document.getElementById('reader-container').classList.remove('active');
        }
        
        
        // =====================================================================
        // CONSOLE RESIZE
        // =====================================================================
        
        /**
         * Set up console panel resize functionality.
         */
        function setupConsoleResize() {
            const handle = document.getElementById('console-resize-handle');
            const panel = document.getElementById('console-panel');
            const content = document.getElementById('console-content');
            let isResizing = false;
            
            handle.addEventListener('mousedown', () => {
                isResizing = true;
                document.body.style.cursor = 'row-resize';
            });
            
            handle.addEventListener('touchstart', () => {
                isResizing = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const height = window.innerHeight - e.clientY;
                if (height > 60 && height < 400) {
                    content.style.height = `${height - 20}px`;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isResizing) return;
                const height = window.innerHeight - e.touches[0].clientY;
                if (height > 60 && height < 400) {
                    content.style.height = `${height - 20}px`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = 'default';
            });
            
            document.addEventListener('touchend', () => {
                isResizing = false;
            });
        }
        
        
        // =====================================================================
        // SETTINGS
        // =====================================================================
        
        /**
         * Show settings (placeholder for future implementation).
         */
        function showSettings() {
            alert('Settings coming in a future update!');
        }
        
        
        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        
        /**
         * Initialize the application on page load.
         */
        window.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').className = 
                savedTheme === 'light' ? 'ph-fill ph-sun' : 'ph-fill ph-moon';
            
            // Set up console resize
            setupConsoleResize();
            
            // Load initial content
            loadPopular();
            
            // Start log polling
            setInterval(refreshLogs, 2000);
        });
    </script>
</body>
</html>
